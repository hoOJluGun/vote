#!/bin/bash

# ðŸ›¡ï¸ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
# Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¾Ð¹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ

set -e  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

warning() {
    echo -e "${YELLOW}âš ï¸ $1${NC}"
}

error() {
    echo -e "${RED}âŒ $1${NC}"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
check_dependencies() {
    log "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker
    if ! command -v docker &> /dev/null; then
        error "Docker Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Docker Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
        exit 1
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker Compose
    if ! command -v docker-compose &> /dev/null; then
        error "Docker Compose Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Docker Compose Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
        exit 1
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Node.js
    if ! command -v node &> /dev/null; then
        error "Node.js Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Node.js Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
        exit 1
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° npm
    if ! command -v npm &> /dev/null; then
        error "npm Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ npm Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°."
        exit 1
    fi
    
    success "Ð’ÑÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
create_directories() {
    log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
    
    mkdir -p backups
    mkdir -p data
    mkdir -p security/logs
    mkdir -p security/reports
    mkdir -p infra/traefik/letsencrypt
    
    success "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"
}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
setup_environment() {
    log "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
    
    if [ ! -f .env ]; then
        warning "Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð¡Ð¾Ð·Ð´Ð°ÑŽ ÑˆÐ°Ð±Ð»Ð¾Ð½..."
        
        cat > .env << EOF
# ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
NODE_ENV=production
PORT=3000

# Ð”Ð¾Ð¼ÐµÐ½Ñ‹
WEB_DOMAIN=your-domain.com
BOT_DOMAIN=bot.your-domain.com
API_DOMAIN=api.your-domain.com

# Telegram Ð±Ð¾Ñ‚Ñ‹
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
TELEGRAM_ALERT_BOT_TOKEN=your_alert_bot_token
TELEGRAM_ALERT_CHAT_ID=your_chat_id

# ÐŸÑ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ñ‹
VERCEL_API_KEY=your_vercel_api_key
VERCEL_TEAM_ID=your_vercel_team_id
AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
AWS_REGION=us-east-1
DIGITALOCEAN_API_KEY=your_do_api_key

# DNS
CLOUDFLARE_API_KEY=your_cloudflare_api_key
CLOUDFLARE_ZONE_ID=your_zone_id

# Webhook Ð°Ð»ÐµÑ€Ñ‚Ñ‹
WEBHOOK_ALERT_URL=https://your-webhook-url.com/alerts
WEBHOOK_ALERT_TOKEN=your_webhook_token

# ACME Ð´Ð»Ñ SSL
ACME_EMAIL=your-email@example.com

# API URLs
API_BASE_URL=https://your-domain.com/api
BOT_BASE_URL=https://bot.your-domain.com
EOF
        
        warning "Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½ Ñ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð½Ñ‹Ð¼Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸. ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÐµÐ³Ð¾ Ð¿ÐµÑ€ÐµÐ´ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸ÐµÐ¼."
        echo "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð¿Ð¾ÑÐ»Ðµ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ .env Ñ„Ð°Ð¹Ð»Ð°..."
        read
    fi
    
    success "ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"
}

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
install_dependencies() {
    log "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
    
    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð»Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
    if [ -d "security" ]; then
        cd security
        npm install
        cd ..
    fi
    
    success "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐµÑ‚Ð¸ Docker
create_docker_network() {
    log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Docker ÑÐµÑ‚Ð¸..."
    
    if ! docker network ls | grep -q "proxy"; then
        docker network create proxy
        success "Docker ÑÐµÑ‚ÑŒ 'proxy' ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
    else
        success "Docker ÑÐµÑ‚ÑŒ 'proxy' ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    fi
}

# Ð—Ð°Ð¿ÑƒÑÐº Traefik
start_traefik() {
    log "Ð—Ð°Ð¿ÑƒÑÐº Traefik..."
    
    cd infra/traefik
    
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ Let's Encrypt
    if [ ! -f "letsencrypt/acme.json" ]; then
        touch letsencrypt/acme.json
        chmod 600 letsencrypt/acme.json
    fi
    
    docker-compose up -d
    
    cd ../..
    
    success "Traefik Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
}

# Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
start_main_services() {
    log "Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
    
    # Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
    docker-compose -f docker-compose.frontend.yml build
    docker-compose -f docker-compose.bot.yml build
    
    # Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
    docker-compose -f docker-compose.frontend.yml up -d
    docker-compose -f docker-compose.bot.yml up -d
    
    success "ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹"
}

# Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
start_security_system() {
    log "Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸..."
    
    # Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¾Ð±Ñ€Ð°Ð·Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
    docker-compose -f docker-compose.security.yml build
    
    # Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
    docker-compose -f docker-compose.security.yml up -d
    
    success "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°"
}

# Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
test_system() {
    log "Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
    
    # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
    sleep 30
    
    # Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
    if [ -f "security/test-security.js" ]; then
        cd security
        node test-security.js
        cd ..
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
    log "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
    docker-compose ps
    
    success "Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾"
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
create_management_scripts() {
    log "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð² ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ..."
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
    cat > stop-all.sh << 'EOF'
#!/bin/bash
echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
docker-compose -f docker-compose.frontend.yml down
docker-compose -f docker-compose.bot.yml down
docker-compose -f docker-compose.security.yml down
docker-compose -f infra/traefik/docker-compose.yml down
echo "âœ… Ð’ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
EOF
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°
    cat > restart-all.sh << 'EOF'
#!/bin/bash
echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
./stop-all.sh
sleep 5
./deploy-secure.sh
echo "âœ… Ð’ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹"
EOF
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
    cat > update-system.sh << 'EOF'
#!/bin/bash
echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
git pull
docker-compose -f docker-compose.frontend.yml build --no-cache
docker-compose -f docker-compose.bot.yml build --no-cache
docker-compose -f docker-compose.security.yml build --no-cache
docker-compose -f docker-compose.frontend.yml up -d
docker-compose -f docker-compose.bot.yml up -d
docker-compose -f docker-compose.security.yml up -d
echo "âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
EOF
    
    # Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
    cat > monitor.sh << 'EOF'
#!/bin/bash
echo "ðŸ“Š ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
echo "=== Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² ==="
docker-compose ps
echo ""
echo "=== Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² ==="
docker stats --no-stream
echo ""
echo "=== Ð›Ð¾Ð³Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ ==="
docker-compose -f docker-compose.security.yml logs --tail=20
EOF
    
    # Ð”ÐµÐ»Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼Ð¸
    chmod +x stop-all.sh restart-all.sh update-system.sh monitor.sh
    
    success "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ cron Ð·Ð°Ð´Ð°Ñ‡
setup_cron() {
    log "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° cron Ð·Ð°Ð´Ð°Ñ‡..."
    
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° cron Ð·Ð°Ð´Ð°Ñ‡
    cat > security-cron << EOF
# Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ - Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 6 Ñ‡Ð°ÑÐ¾Ð²
0 */6 * * * cd $(pwd) && docker-compose -f docker-compose.security.yml exec -T backup-service node backup-manager.js

# Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚
*/5 * * * * cd $(pwd) && docker-compose -f docker-compose.security.yml exec -T security-manager node health-check.js

# Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ - Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð»Ð¾Ð³Ð¾Ð² ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 2:00
0 2 * * * cd $(pwd) && find ./security/logs -name "*.log" -mtime +7 -delete

# Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ - Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¿Ð¸Ð¹ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 3:00
0 3 * * * cd $(pwd) && find ./backups -name "*.tar.gz" -mtime +30 -delete
EOF
    
    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° cron Ð·Ð°Ð´Ð°Ñ‡ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ root)
    if [ "$EUID" -eq 0 ]; then
        crontab security-cron
        success "Cron Ð·Ð°Ð´Ð°Ñ‡Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
    else
        warning "Ð”Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ cron Ð·Ð°Ð´Ð°Ñ‡ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: sudo crontab security-cron"
    fi
    
    rm security-cron
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    echo "ðŸ›¡ï¸ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð°Ð½Ð¸Ñ"
    echo "=============================================================="
    
    check_dependencies
    create_directories
    setup_environment
    install_dependencies
    create_docker_network
    start_traefik
    start_main_services
    start_security_system
    test_system
    create_management_scripts
    setup_cron
    
    echo ""
    echo "ðŸŽ‰ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
    echo ""
    echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
    echo "1. ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» .env Ñ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸"
    echo "2. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ DNS Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ Ð²Ð°ÑˆÐ¸Ñ… Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð²"
    echo "3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹: ./monitor.sh"
    echo "4. ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸: cd security && npm run test:security"
    echo ""
    echo "ðŸ”§ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
    echo "- ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°: ./stop-all.sh"
    echo "- ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº: ./restart-all.sh"
    echo "- ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ: ./update-system.sh"
    echo "- ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³: ./monitor.sh"
    echo ""
    echo "ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: ./security/README.md"
    echo ""
    echo "âš ï¸ Ð’Ð°Ð¶Ð½Ð¾: Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾!"
}

# Ð—Ð°Ð¿ÑƒÑÐº Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
main "$@"
